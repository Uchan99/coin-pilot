# config/strategy_v3.yaml
# v3.3 업데이트: RSI7 trigger/recover를 v3.0 수준으로 복원 (BEAR 30, SIDEWAYS 35)

regime_detection:
  ma_fast_period: 50
  ma_slow_period: 200
  bull_threshold_pct: 2.0
  bear_threshold_pct: -2.0
  check_interval_hours: 1
  unknown_fallback: "SIDEWAYS"
  redis_ttl_seconds: 7200  # 2시간 (스케줄러 1시간 간격 대비 여유 확보)

data:
  source_timeframe: "1m"
  indicator_timeframe: "1h"
  min_hourly_candles_for_regime: 200

regimes:
  BULL:
    entry:
      rsi_14_max: 50
      rsi_7_trigger: 42
      rsi_7_recover: 42
      rsi_7_recovery_lookback: 5
      min_rsi_7_bounce_pct: 2.0        # RSI(7) 최소 반등 폭 (포인트)
      ma_condition: "crossover"         # MA20 상향 돌파
      ma_period: 20
      bb_enabled: false
      volume_ratio: 1.0                 # 상한 조건: 평균 대비 1.0배 이상 필요
      volume_min_ratio: null            # 하한 조건: 상승장에서는 미적용
      ai_prefilter_enabled: true
      ai_prefilter_min_context_candles: 12
      ai_reject_cooldown_min_1: 5
      ai_reject_cooldown_min_2: 10
      ai_reject_cooldown_min_3: 15
      ai_reject_cooldown_window_min: 30
      ai_max_calls_per_hour: 20
      ai_max_calls_per_day: 120
      ai_credit_block_minutes: 60
      ai_error_streak_threshold: 5
      ai_error_block_minutes: 30
    exit:
      take_profit_pct: 0.05
      stop_loss_pct: 0.03
      trailing_stop_pct: 0.03
      trailing_stop_activation_pct: 0.01
      rsi_overbought: 75
      rsi_exit_min_profit_pct: 0.01
      time_limit_hours: 72
    position_size_ratio: 1.0

  SIDEWAYS:
    entry:
      rsi_14_max: 48
      rsi_7_trigger: 40
      rsi_7_recover: 42
      rsi_7_recovery_lookback: 5
      min_rsi_7_bounce_pct: 3.0        # RSI(7) 최소 반등 폭
      ma_condition: "proximity"
      ma_period: 20
      ma_proximity_pct: 0.985
      bb_enabled: true
      bb_period: 20
      bb_std: 2.0
      bb_touch_lookback: 30
      bb_recovery_sustain_candles: 2
      require_price_above_bb_lower: true  # BB 하단 아래에서는 진입 금지
      volume_ratio: null                  # 상한 조건: 횡보장에서는 미적용
      volume_min_ratio: 0.4               # 하한 조건: 최소 40% 이상 필요
      ai_prefilter_enabled: true
      ai_prefilter_min_context_candles: 12
      ai_reject_cooldown_min_1: 5
      ai_reject_cooldown_min_2: 10
      ai_reject_cooldown_min_3: 15
      ai_reject_cooldown_window_min: 30
      ai_max_calls_per_hour: 20
      ai_max_calls_per_day: 120
      ai_credit_block_minutes: 60
      ai_error_streak_threshold: 5
      ai_error_block_minutes: 30
    exit:
      take_profit_pct: 0.03
      stop_loss_pct: 0.04
      trailing_stop_pct: 0.025
      trailing_stop_activation_pct: 0.01
      rsi_overbought: 70
      rsi_exit_min_profit_pct: 0.01
      time_limit_hours: 48
    position_size_ratio: 0.9

  BEAR:
    entry:
      rsi_14_max: 42
      rsi_7_trigger: 30
      rsi_7_recover: 30
      rsi_7_recovery_lookback: 5
      min_rsi_7_bounce_pct: 2.0           # RSI(7) 최소 반등 폭
      ma_condition: "proximity_or_above"   # MA20 위 돌파 OR MA20 아래 3% 이내
      ma_period: 20
      ma_proximity_pct: 0.97
      bb_enabled: false
      require_price_above_bb_lower: true   # BB 하단 아래에서는 진입 금지 (Falling Knife 방지)
      volume_ratio: null                   # 상한 조건: 하락장에서는 미적용
      volume_min_ratio: 0.2                # 하한 조건: 최소 20% 이상 필요
      volume_surge_check: true             # 직전 급락 시 거래량 급증 여부 체크
      volume_surge_ratio: 2.0              # 직전 3캔들 중 평균 대비 2배 이상 급증 있으면 진입 보류
      ai_prefilter_enabled: true
      ai_prefilter_min_context_candles: 12
      ai_prefilter_max_downtrend_ratio: 0.85
      ai_prefilter_min_rebound_pct: 0.4
      ai_prefilter_min_volume_recovery_ratio: 0.7
      ai_reject_cooldown_min_1: 5
      ai_reject_cooldown_min_2: 10
      ai_reject_cooldown_min_3: 15
      ai_reject_cooldown_window_min: 30
      ai_max_calls_per_hour: 20
      ai_max_calls_per_day: 120
      ai_credit_block_minutes: 60
      ai_error_streak_threshold: 5
      ai_error_block_minutes: 30
    exit:
      take_profit_pct: 0.03
      stop_loss_pct: 0.05
      trailing_stop_pct: 0.02
      trailing_stop_activation_pct: 0.01
      rsi_overbought: 70
      rsi_exit_min_profit_pct: 0.005
      time_limit_hours: 24
    position_size_ratio: 0.7

risk_management:
  # 100만원 운용 기준:
  # - 심볼당 기본 주문 타깃 20%
  # - 필요 시 5심볼 합산 100% 홀딩 허용
  max_position_size: 0.20
  max_total_exposure: 1.00
  max_concurrent_positions: 5
  allow_same_coin_duplicate: false
  # 초기 실거래 전환 구간 보호용 일일 리스크(보수적)
  max_daily_loss: 0.03
  max_daily_trades: 6
  cooldown_after_consecutive_losses: 3
  cooldown_hours: 2
