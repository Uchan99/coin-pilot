# 20. OCI 유료 전환 대비 보안/과금 가드레일 강화 계획

**작성일**: 2026-02-22  
**작성자**: Codex (GPT-5)  
**상태**: In Progress (2026-02-23)  
**관련 계획 문서**: `docs/work-plans/18_cloud_migration_cost_optimized_deployment_plan.md`  
**관련 하위 계획 문서**: `docs/work-plans/20-01_project_wide_security_hardening_plan.md`  
**관련 결과 문서**: `docs/work-result/20_oci_paid_tier_security_and_cost_guardrails_result.md`  

---

## 0. 트리거(Why started)
- 유저가 "유료 계정 전환 후 보안 사고 시 과금 폭탄 가능성"을 핵심 리스크로 제기함.
- 실제 점검에서 대시보드 인증 부재, n8n webhook 검증 미흡, 기본 비밀번호 폴백 등 비용/보안 연계 리스크가 확인됨.
- 18번(클라우드 이관) 진행 중이지만, 유료 전환 전에 보안선(P0)을 먼저 고정하지 않으면 운영 리스크가 큼.

## 1. 문제 요약
- 증상:
  - 유료 계정 전환 시 무단 접근/오용이 비용 증가(LLM API, 인프라 증설, outbound 트래픽)로 직결될 수 있음.
- 영향 범위(기능/리스크/데이터/비용):
  - 기능: 대시보드/챗봇, n8n 알림, OCI 리소스 생성 경로
  - 리스크: 계정 키 유출, webhook 위조 호출, 공개 포트 오노출
  - 비용: API 호출 과다, 리소스 과생성, 예기치 않은 네트워크/스토리지 과금
- 재현 조건:
  - 443으로 대시보드 공개 + 인증 미적용
  - n8n 외부 노출 + webhook secret 검증 누락
  - Budget만 설정하고 Quota 미적용

## 2. 목표 / 비목표
### 2.1 목표
1. 유료 전환 전 "과금 폭탄" 경로를 구조적으로 차단한다.
2. 외부 공개 포트를 최소화하고(22/80/443), 내부 서비스는 비공개 원칙을 강제한다.
3. 키/시크릿/웹훅을 "유출되더라도 빠르게 차단 가능한 운영 절차"로 바꾼다.
4. Budget(알림) + Quota(강제 제한) + 모니터링(탐지)을 함께 구성한다.

### 2.2 비목표
1. 이번 단계에서 OKE/EKS 급의 대규모 보안 아키텍처로 확장하지 않는다.
2. 완전 무중단 보안 인프라(예: WAF 전면 적용, SIEM 완전 연동)까지는 범위에 넣지 않는다.

---

## 3. 아키텍처 선택 및 대안 비교

### 3.1 최종 선택
- **단일 OCI VM + Docker Compose 유지**
- **보안 경계는 OCI 네트워크 + Reverse Proxy + 앱 인증 + 비용 가드레일**의 4계층으로 구성

### 3.2 대안 비교
1. OKE(관리형 K8s)로 즉시 전환
- 장점: 네트워크/정책 통제 수단이 풍부함
- 단점: 현재 단계에서 운영 복잡도/비용 증가, 전환 속도 저하

2. Cloudflare Access 등 외부 SSO만 먼저 붙이고 내부 보안은 후순위
- 장점: 대시보드 접근 제어를 빠르게 강화
- 단점: 내부 시크릿/웹훅/과금 제한 문제는 남음

3. Compose 유지 + 보안/비용 가드레일 우선 강화 (**채택**)
- 장점: 현재 18번 진행과 충돌이 적고, 즉시 리스크 감소 효과 큼
- 단점: 장기적으로는 OKE 수준 정책 정밀도가 부족

### 3.3 채택 근거
- 현재 병목은 "배포 방식"보다 "보안/비용 가드레일 부재"에 가까움.
- 즉시 적용 가능한 통제(포트, 인증, webhook 검증, quota)가 존재함.
- 시행착오 비용이 낮고, 이후 OKE 전환 시에도 운영 원칙을 그대로 재사용 가능.

---

## 4. 범위 및 작업 항목 (Why / 장점 / 추가 작업 포함)

### 4.1 네트워크/포트 정책 고정 (P0)

| 항목 | 왜 해야 하는가 | 기대 효과(좋은 점) | 추가 작업 |
|---|---|---|---|
| 외부 공개 포트 최소화: `22`, `80`, `443`만 허용 | 공개 포트가 많을수록 스캔/침입 표면 증가 | 공격면 축소, 운영 단순화 | `80`은 HTTP->HTTPS 리다이렉트 및 인증서 발급용으로 사용 여부 확정 |
| 내부 서비스(`5432`,`6379`,`5678`,`9090`,`3000`,`8000`,`8501`) 외부 차단 | DB/Redis/모니터링 직접 노출 시 즉시 고위험 | 데이터 보호 + 측면 이동( lateral movement ) 방지 | OCI Security List/NSG 규칙 점검 체크리스트 작성 |
| SSH 접근 소스 제한(가능하면 고정 IP) | 22포트 무제한 개방은 무차별 대입 위험 | 침입 시도 감소, 로그 노이즈 감소 | 고정IP 불가 시 fail2ban/키 전용 정책 강화 |

### 4.2 인증/접근제어 강화 (P0)

| 항목 | 왜 해야 하는가 | 기대 효과(좋은 점) | 추가 작업 |
|---|---|---|---|
| 대시보드(443) 앞단 인증 의무화 (Basic Auth/OIDC/Access) | 현재 앱 레벨 로그인 부재 시 누구나 챗봇 호출 가능 | LLM API 남용 방지, 운영 화면 보호 | 최소 1개 인증 방식 표준안 결정 및 비상 우회 절차 정의 |
| n8n 외부 공개 금지(내부 또는 터널 접근) | n8n은 자동화 권한이 커서 공격 시 파급 큼 | 워크플로우 변조/웹훅 오남용 차단 | 유지보수용 SSH 터널 접속 가이드 작성 |
| Grafana 기본 계정/비밀번호 강제 변경 | 기본값 잔존 시 침해 난이도 매우 낮음 | 모니터링 시스템 무단 접근 방지 | 패스워드 로테이션 주기(예: 분기 1회) 정의 |

### 4.3 시크릿/키 관리 강화 (P0)

| 항목 | 왜 해야 하는가 | 기대 효과(좋은 점) | 추가 작업 |
|---|---|---|---|
| API 키 전량 로테이션(Upbit/OpenAI/Anthropic/Discord) | 로컬/터미널 노출 이력 가능성 제거 필요 | 기존 유출 위험 세션 즉시 무력화 | 로테이션 순서(runbook) + 장애 시 롤백 순서 문서화 |
| `.env` 권한 `600`, 파일 소유자 제한 | 로컬 계정 침해 시 평문 시크릿 탈취 위험 | 최소 권한 원칙 준수 | 운영 점검 스크립트에 권한 체크 추가 |
| `default fallback` 제거 (`postgres`, `admin`) | `.env` 누락 시 취약 설정으로 기동될 수 있음 | 실수 기반 보안사고 예방 | 필수 env 누락 시 컨테이너 fail-fast 적용 |

### 4.4 n8n 웹훅 검증 강화 (P0)

| 항목 | 왜 해야 하는가 | 기대 효과(좋은 점) | 추가 작업 |
|---|---|---|---|
| 모든 webhook에 `X-Webhook-Secret` 검증 노드 추가 | 현재 헤더를 보내도 n8n이 검증하지 않으면 위조 요청 가능 | 봇 이벤트 위조/스팸 호출 차단 | 워크플로우 JSON 템플릿 표준화 |
| `N8N_BLOCK_ENV_ACCESS_IN_NODE=true` 전환 | 노드가 env 전체 접근 가능하면 유출면 증가 | 키 노출 가능성 감소 | 기존 워크플로우가 env 의존하는 부분 영향도 점검 |
| webhook 엔드포인트 랜덤화/버전관리 | 단순 경로(`/webhook/trade`)는 탐색에 취약 | 무작위 스캔 저항성 향상 | endpoint 변경 시 bot 설정 동기화 자동화 |

### 4.5 OCI 과금 가드레일 (P0)

| 항목 | 왜 해야 하는가 | 기대 효과(좋은 점) | 추가 작업 |
|---|---|---|---|
| Budget(예: 1 USD) + 다단계 알림 설정 | 예산 초과 조기 탐지 | 이상 비용을 조기에 인지 | 알림 채널(메일/Discord) 이중화 |
| Quota 정책으로 고비용 리소스 생성 제한 | Budget은 soft limit(차단 아님) | 과금 폭탄의 근본 원인(무단 생성) 차단 | compartment별 quota 정책 문서화 |
| Free tier 범위 모니터링(컴퓨트/볼륨/백업) | 무료 한도 초과 시 자동 과금 가능 | 비용 예측 가능성 향상 | 월간 비용 점검 루틴 정례화 |

### 4.6 운영 탐지/대응 (P1)

| 항목 | 왜 해야 하는가 | 기대 효과(좋은 점) | 추가 작업 |
|---|---|---|---|
| 실패 로그인/비정상 요청 알림 | 공격 징후를 늦게 보면 대응 비용 증가 | 조기 차단 및 피해 최소화 | fail2ban, nginx/caddy 로그 알림 연동 |
| 리소스 급증(CPU/네트워크/API 호출) 알림 | 과금 징후는 대개 사용량 급증으로 먼저 나타남 | 비용 이상징후 조기 대응 | Prometheus 경보 규칙 임계값 튜닝 |
| Incident Runbook(격리/키폐기/복구) 준비 | 사고 시 절차 부재가 피해 확대 원인 | 대응시간 단축, 재발 방지 | 온콜 체크리스트와 복구 순서 고정 |

### 4.7 코드 보안 감사 핵심 구성요소 반영 (P0)

`docs/security/docs1.md`의 핵심 구성요소를 본 프로젝트 실행 항목으로 매핑한다.

| 항목 | 왜 해야 하는가 | 기대 효과(좋은 점) | 추가 작업 |
|---|---|---|---|
| 아키텍처/설계 분석 | 코드 라인 단위 결함 이전에 구조적 신뢰경계 문제를 제거해야 함 | 단일 장애점, 과도 권한 경로 조기 차단 | 서비스 간 trust boundary 다이어그램 작성 |
| 의존성/라이브러리 점검(SCA) | 제3자 라이브러리 CVE는 침투의 대표 경로 | 공급망 취약점 조기 탐지/패치 | SBOM 생성 + 취약점 등급 정책 수립 |
| 정적/동적 분석(SAST/DAST) | 자동화 없이는 광범위 결함 탐지가 어려움 | PR 단계에서 위험 코드 조기 차단 | CI 파이프라인에 보안 게이트 추가 |
| 로깅/감사추적 강화 | 침해는 완전 예방이 어려워 탐지/추적이 필수 | 이상행위 탐지 및 포렌식 가능성 향상 | 민감 이벤트 표준 로그 스키마 정의 |
| 규정/정책 통합 | 보안활동이 문서/정책과 분리되면 재발 가능성 증가 | 감사 대응력 및 재현 가능한 운영 확보 | 내부 보안 체크리스트와 릴리스 체크 연동 |

### 4.8 코드 보안 감사 수행 단계(End-to-End) (P0)

| 단계 | 왜 해야 하는가 | 기대 효과(좋은 점) | 추가 작업 |
|---|---|---|---|
| 범위 정의/자산 열거 | 누락된 저장소/서비스는 공격자가 악용하기 쉬움 | 감사 커버리지 누락 최소화 | 저장소/서비스/컨테이너 인벤토리 유지 |
| 도구 선택/규칙 구성 | 스택에 맞지 않는 도구는 오탐/미탐이 많음 | 탐지 정확도 향상 | Python/FastAPI/Container 기준 규칙셋 확정 |
| 수동 검사/위협 모델링 | 자동화로 잡기 어려운 비즈니스 로직 결함 보완 | 고난도 공격경로(연쇄 취약점) 식별 | 핵심 모듈 위협 시나리오 문서화 |
| 보고/우선순위 | 취약점 분류 없이는 수정 우선순위 혼선 | 리소스 효율적 배분 | High/Medium/Low SLA 정의 |
| 수정/재검증 | 패치 후 미검증은 회귀/잔존 취약점 위험 | 실제 개선 효과 보장 | 부분 재스캔 + 회귀 테스트 자동화 |

### 4.9 코드 감사 기법/도구 트랙 (P1)

| 항목 | 왜 해야 하는가 | 기대 효과(좋은 점) | 추가 작업 |
|---|---|---|---|
| SAST(정적 분석) | 커밋 단계에서 취약 패턴 조기 차단 가능 | 배포 전 리스크 감소 | Semgrep/Bandit 후보 평가 및 1개 확정 |
| DAST/IAST(동적 분석) | 런타임 경로 취약점 탐지에 유리 | 실행 환경 기반 결함 탐지 | 스테이징 대상 보안 테스트 루틴 정의 |
| 퍼징/스트레스 테스트 | 비정형 입력 기반 취약점 발견 | 예외/충돌/처리 취약점 조기 발견 | 고위험 입력 포인트(fastapi 엔드포인트) 선정 |
| 수동 코드 리뷰/페어 리뷰 | 자동화 미탐 논리 결함 보완 | 코드 품질+보안 동시 향상 | 보안 리뷰 체크리스트 PR 템플릿 반영 |
| 위협 모델링/공격표면 분석 | 신규 기능의 공격면 사전 축소 | 설계 단계 방어 강화 | 기능 설계서에 Threat 섹션 의무화 |
| 안전한 구성/환경변수 관리 | 평문 비밀/오구성은 즉시 고위험 | 시크릿 유출면 축소 | `.env` 정책 + 시크릿 주입 표준화 |

### 4.10 예상 난점과 완화 전략 (P1)

| 난점 | 왜 발생하는가 | 완화 효과 | 추가 작업 |
|---|---|---|---|
| 분산/레거시 저장소 누락 | 히스토리 자산과 신규 코드가 혼재 | 사각지대 감소 | 감사 대상 인벤토리 자동 점검 스크립트 |
| 인력/시간 부족 | 스프린트 우선순위가 기능 중심으로 쏠림 | 보안 활동 지속성 확보 | \"보안 고정 슬롯\" 스프린트에 배정 |
| 자동화 vs 수동 균형 문제 | 자동화만으로는 로직 결함 미탐 가능 | 탐지 품질 향상 | High 리스크 모듈 수동검토 의무화 |
| 짧은 개발 주기 | 릴리스 압박으로 보안 게이트 생략 위험 | 취약 코드 유입 차단 | PR 머지 조건에 보안 체크 포함 |
| 지속개선 중단 | 일회성 감사로 끝나기 쉬움 | 재발률 감소 | 월간 재감사 캘린더 고정 |

### 4.11 감사 후 실행 계획(Post-Audit) (P0)

| 항목 | 왜 해야 하는가 | 기대 효과(좋은 점) | 추가 작업 |
|---|---|---|---|
| 발견사항 분류/우선순위 | 모든 취약점을 동일하게 다루면 대응 실패 | 고위험 우선 처리 | Risk register 운영 |
| 담당자/기한 지정 | 책임이 없으면 장기 미해결 발생 | 수정 속도/완료율 향상 | 티켓 시스템 SLA 적용 |
| 수정 검증/부분 재스캔 | 패치 후 검증 없으면 회귀 위험 | 수정 정확도 보장 | CI에서 재검증 단계 자동화 |
| 교훈 문서화/정책 조정 | 같은 실수가 반복될 수 있음 | 조직 학습 강화 | 위키/가이드 갱신 프로세스 고정 |
| 차기 감사 일정 수립 | 무계획 재감사는 누락을 유발 | 감사의 연속성 확보 | 분기/릴리스 단위 주기 확정 |

### 4.12 코드 보안 감사 주기 정책 (P0)

| 주기 | 왜 해야 하는가 | 기대 효과(좋은 점) | 추가 작업 |
|---|---|---|---|
| PR/커밋 단위(경량 SAST/SCA) | 취약 코드의 조기 유입 차단 | 릴리스 직전 보안 병목 감소 | CI 병렬 실행 최적화 |
| 릴리스 전(심화 점검) | 배포 직전 위험 누락 방지 | 운영 반영 전 위험도 확정 | 릴리스 보안 체크리스트 게이트화 |
| 월간(종합 점검) | 누적 리스크/기술부채 관리 | 지속 개선 및 재발 방지 | 월간 보안 리포트 템플릿 운영 |
| 분기(정책/규정 리뷰) | 규정/정책 변경 반영 필요 | 감사 대응력 강화 | Charter/Runbook 정책 업데이트 |

---

## 5. 단계별 실행 계획

### Phase 1 (즉시, 1일)
1. 키 로테이션(Upbit/OpenAI/Anthropic/Discord)
2. `.env`/권한/기본값 하드닝
3. 포트 정책 재확인 (`22`,`80`,`443` 외 외부 차단)
4. Budget + Quota 적용

완료 기준:
- 신규 키로 정상 동작
- `ss -tulpen` / OCI 보안규칙에서 외부 공개 포트가 정책과 일치
- 예산/쿼터가 콘솔에서 활성 상태

### Phase 2 (단기, 1~2일)
1. 대시보드 인증 계층 적용
2. n8n webhook secret 검증 노드 전면 반영
3. `N8N_BLOCK_ENV_ACCESS_IN_NODE=true` 반영 후 회귀 테스트
4. 코드 보안 감사 범위 확정(저장소/모듈/의존성) + 도구 선정(SAST/SCA)
5. 수동 위협 모델링 1차(대시보드, 봇 API, n8n 경로)

완료 기준:
- 인증 없이는 대시보드 접근 불가
- 잘못된 webhook secret 요청 차단 확인
- 코드 보안 감사 실행 계획서(범위/도구/SLA) 확정

### Phase 3 (운영 안정화, 2~3일)
1. 경보 규칙(Prometheus/Grafana) 강화
2. 사고 대응 runbook 완성
3. 월간 보안/비용 점검 루틴 문서화
4. 코드 보안 감사 1회 수행(SAST/SCA/수동검토) + 리포트 발행
5. 발견 취약점 우선순위 티켓화 및 재스캔 검증

완료 기준:
- 이상징후 시 테스트 알림 수신 성공
- 트러블슈팅 문서와 복구 절차 연결 완료
- 보안 감사 결과서와 수정 증적(재스캔 결과) 확보

---

## 6. 검증 기준 (How to verify)

### 6.1 네트워크/포트
- OCI Security List/NSG에서 ingress 허용 포트 확인
- VM에서 확인:
```bash
sudo ss -tulpen | rg ':22|:80|:443|:5432|:6379|:5678|:8000|:8501|:9090|:3000'
```
기대값:
- 외부 접근 허용은 `22/80/443`만
- 나머지는 loopback 또는 내부 네트워크 한정

### 6.2 인증/웹훅
- 대시보드 URL 접속 시 인증 프롬프트 확인
- webhook에 잘못된 secret 헤더로 요청 시 401/403 확인
- 정상 secret 요청만 통과 확인

### 6.3 비용 가드레일
- Budget 알림 테스트 이벤트 확인
- Quota 위반 리소스 생성 시 실패 확인
- Cost Analysis에서 일일 증감 추이 체크

### 6.4 코드 보안 감사
- SAST 실행 및 High 이슈 0건 확인(또는 예외 승인 문서화)
- SCA 실행 및 알려진 High/Critical CVE 처리 계획 수립
- 수동 코드 리뷰 체크리스트(인증/입력검증/시크릿/권한) 완료
- 재검증 스캔 결과에서 동일 이슈 재발 없음 확인

### 6.5 감사 주기 준수
- PR 단계 보안 스캔 실행 이력 확인
- 릴리스 전 보안 체크리스트 완료 기록 확인
- 월간/분기 보안 리포트 발행 여부 확인

---

## 7. 구현/수정 대상 파일(예정)

### 7.1 코드/배포
- `deploy/cloud/oci/docker-compose.prod.yml`
- `deploy/cloud/oci/.env.example`
- `config/n8n_workflows/*.json`
- (필요 시) reverse proxy 설정 파일(`deploy/cloud/oci/*` 신규)
- (필요 시) CI 보안 스캔 워크플로우(`.github/workflows/*` 신규/수정)
- (필요 시) 보안 점검 스크립트(`scripts/security/*` 신규)

### 7.2 문서
- `docs/runbooks/18_data_migration_runbook.md` (운영 절차 보안 보강)
- `docs/runbooks/18_oci_a1_flex_a_to_z_guide.md` (포트/인증/보안 절차 추가)
- `docs/troubleshooting/20_*.md` (이슈 발생 시)
- `docs/work-result/20_oci_paid_tier_security_and_cost_guardrails_result.md`
- `docs/security/docs1.md` (코드 보안 감사 기준 참조 문서)

---

## 8. 롤백 전략
- 보안 설정 롤백은 "전체 복구"가 아니라 "최소 기능 복구" 원칙으로 진행
1. 인증 계층 장애 시 임시 allowlist 기반 접근으로 우회
2. webhook 검증 오류 시 특정 workflow만 이전 버전 복원
3. 키 로테이션 장애 시 즉시 이전 키 재활성화(사전 보관분)

주의:
- 보안 약화 롤백은 시간 제한(예: 1시간)으로 관리하고, 즉시 재강화 작업을 동시 착수

---

## 9. 리스크/가정/미확정

### 9.1 가정
- 운영 대상은 OCI 단일 VM + Compose 유지
- 외부 공개 서비스는 dashboard(HTTPS) 중심

### 9.2 미확정
- 대시보드 인증 방식을 Basic Auth로 갈지 OIDC로 갈지 최종 결정 필요
- `80` 포트 상시 개방 여부(리다이렉트/인증서 갱신 정책)에 대한 운영 결정 필요

### 9.3 리스크
- 인증/시크릿 강화 과정에서 일시적인 접근 장애 가능
- webhook 검증 강화 시 기존 n8n 플로우 일부 실패 가능

완화:
- 단계적 배포(phase별), 사전 검증, 즉시 롤백 경로 유지

---

## 10. 문서 추적성(Traceability)
- 본 계획은 18번 클라우드 이관 계획의 보안/비용 리스크를 별도 스트림으로 분리해 다룬다.
- 구현 후 결과 문서는 반드시 본 계획을 참조한다.
- 운영 이슈 발생 시 `docs/troubleshooting/20_*.md`를 추가하고 plan/result에 링크한다.

---

## 11. 체크리스트
- [ ] 키 로테이션 완료 및 정상 동작 확인
- [ ] 외부 포트 정책(22/80/443) 재검증
- [ ] 대시보드 인증 적용
- [ ] n8n webhook secret 검증 적용
- [ ] Budget + Quota 동시 적용
- [ ] 보안/비용 모니터링 알림 동작 확인
- [ ] 코드 보안 감사 범위/도구/SLA 확정
- [ ] SAST/SCA/수동검토 1회 수행 및 결과 기록
- [ ] High 위험 취약점 조치 완료 또는 예외 승인 문서화
- [ ] 재스캔으로 수정 검증 완료
- [ ] 결과 문서 작성 및 plan/result/charter 링크 정리

---

## 12. 계획 변경 이력
### 2026-02-22
1. 신규 계획 생성
2. 유료 전환 전 필수 보안선(P0)과 운영 고도화(P1)를 분리해 단계화
3. 각 항목에 Why/장점/추가 작업을 포함한 실행표 추가
4. `docs/security/docs1.md` 기반 코드 보안 감사 트랙(구성요소/수행단계/기법/난점/사후조치) 반영
5. 코드 보안 감사 주기 정책(PR/릴리스/월간/분기) 추가

### 2026-02-23
1. 운영 compose 보안 하드닝 반영 범위 확정(필수 env fail-fast, n8n env 접근 차단, 대시보드 접근 비밀번호)
2. n8n webhook secret 검증 노드 표준화 범위를 모든 알림 워크플로우로 확장
3. 배포 전 점검 자동화를 위해 `scripts/security/preflight_security_check.sh` 추가
