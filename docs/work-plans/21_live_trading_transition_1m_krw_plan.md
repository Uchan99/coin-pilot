# 21. 100만원 기준 실거래 전환(페이퍼 1/10 축소 포함) 계획

**작성일**: 2026-02-24  
**작성자**: Codex (GPT-5)  
**상태**: Planned  
**관련 계획 문서**: `docs/work-plans/18_cloud_migration_cost_optimized_deployment_plan.md`, `docs/work-plans/20_oci_paid_tier_security_and_cost_guardrails_plan.md`  
**관련 하위 계획 문서**: `docs/work-plans/21-01_reference_equity_three_cap_execution_plan.md` (완료), `21-02`, `21-03`, `21-04`, `21-05`  

---

## 0. 트리거(Why started)
- 사용자가 며칠간 추가 안정화 후, 실제 자금 100만원으로 자동매매 전환 의사를 명확히 제시함.
- 현재 기준은 Paper 1,000만원이므로, 실거래 전환 전 `규모 1/10` 환경에서 운영 리스크를 먼저 검증할 필요가 있음.
- 최근 모니터링/알림/Grafana 정합성 보정이 완료되어, 이제 "실거래 준비"를 위한 별도 계획 분리가 적절한 시점임.

## 1. 문제 요약
- 증상:
  - 현재 엔진은 `PaperTradingExecutor` 중심이며, 거래소 실주문 실행기(Upbit live executor)는 아직 부재.
  - 모의자금(1,000만원) 기준 성능/리스크 결과를 100만원 실운영에 그대로 이식하면 과적합/과신 위험이 있음.
- 영향 범위(기능/리스크/데이터/비용):
  - 기능: 주문 실행 계층(Paper -> Live) 전환 필요
  - 리스크: 키 유출, 오주문, 과도한 주문 빈도, 수수료/슬리피지 영향
  - 데이터: 거래소 체결내역과 DB 동기화(정산) 경로 필요
  - 비용: 실거래 손실 + API/인프라 운영비
- 재현 조건:
  - 실거래 모드 도입 시, 현재 Paper 가정(즉시체결/무슬리피지)과 실제 체결 환경 차이 발생

## 2. 목표 / 비목표

### 2.1 목표
1. **규모 전환 검증**: Paper 자본을 1,000만원 -> 100만원으로 축소하여 1/10 환경 성능/안정성 검증
2. **실거래 준비 완료 상태 정의**: 전환 전 필수 게이트(보안/리스크/운영)를 수치로 고정
3. **안전한 Live 전환**: 100만원 실거래를 단계적으로 활성화(드라이런 -> 소액 -> 전체)
4. **즉시 롤백 보장**: 이상 징후 발생 시 `paper mode`로 즉시 회귀 가능한 절차 확보

### 2.2 비목표
1. 이번 계획에서 즉시 대규모 자본 확장(>100만원)은 진행하지 않음
2. 파생상품/레버리지/공매도 등 고위험 상품 확장은 포함하지 않음
3. 복수 거래소 멀티브로커 오케스트레이션은 범위 밖

---

## 3. 아키텍처 선택 및 대안 비교

### 3.1 최종 선택
- **단계적 3-Stage 전환 방식** 채택
  1) Paper 100만원 축소 운영
  2) Live 드라이런(주문 미전송 검증)
  3) Live 소액 운영 후 100만원 전체 활성화

### 3.2 대안 비교
1. 즉시 100만원 실거래 전환
- 장점: 전환 속도 빠름
- 단점: 실행계층/정산/보안 누락 시 손실 리스크 과대

2. Paper 1,000만원 유지 후 실거래 전환
- 장점: 기존 지표 연속성
- 단점: 실제 목표 규모(100만원)와 리스크 체감 불일치

3. **Paper 100만원 선검증 -> Live 단계 전환 (채택)**
- 장점: 자금 규모/리스크/주문 최소단위 현실성을 미리 검증 가능
- 단점: 전환까지 시간 추가 소요

### 3.3 채택 근거
- 현재 시스템은 전략/리스크/알림 계층은 안정화 중이나, 실주문 계층은 미구현 상태.
- 실거래 전환 실패의 대부분은 "전략"보다 "운영/실행/정산" 문제에서 발생.
- 1/10 축소 검증은 과도한 손실 위험을 줄이며 실거래 준비도를 객관적으로 측정 가능.

---

## 4. 단계별 설계 (핵심)

### 4.1 Stage A: Paper 자본 100만원 축소 운영 (필수 선행)

#### A-1. 구성 변경
- `PAPER_BALANCE=1000000` 적용
- 기존 포지션/잔고 상태 초기화 정책 명시
  - 옵션 1: `account_state`만 100만원으로 리셋
  - 옵션 2: Paper 상태 전체 리셋(권장: 실거래 전환 전 기준점 확보)

#### A-2. 리스크 파라미터(100만원 전용 제안값)
- 단일 주문 상한: **3%** (30,000 KRW)
- 일일 최대 손실: **-2%** (20,000 KRW)
- 일일 최대 신규 BUY: **3회**
- 연속 손실 쿨다운: 기존보다 강화(예: 2연패 시 2시간)

#### A-3. 관측 항목
- 주문 시도 대비 체결(모의) 비율
- AI REJECT 비율/원인 분포
- 일일 PnL 분산/최대 낙폭
- n8n/Discord/Grafana 누락률

#### A-4. Stage A 통과 기준
- 연속 3~7일 무중단
- Critical 오류 0건
- 일일 손실 한도 위반 0건
- 모니터링 공백(알림 누락) 0건

---

### 4.2 Stage B: Live 실행 계층 구축 (실주문 전송 전)

#### B-1. 구현 항목
- `LiveTradingExecutor` 신규 구현
  - 주문 생성/조회/취소
  - 체결 상태 폴링/반영
  - 네트워크 재시도/중복주문 방지 키(idempotency)
- `TRADING_MODE=paper|live` 스위치 도입
- 정산(리컨실리에이션) 잡 추가
  - 거래소 체결 내역 vs DB `trading_history` 대조

#### B-2. 보안 항목
- Upbit API 키 최소 권한(주문/조회, 출금 비활성)
- IP 화이트리스트 고정
- 키 로테이션/폐기 런북
- 실거래 시크릿은 `deploy/cloud/oci/.env`만 사용(권한 600)

#### B-3. Stage B 통과 기준
- 드라이런 모드에서 주문 payload/서명/응답 검증 통과
- 오주문/중복주문 시뮬레이션 테스트 통과
- 정산 잡에서 불일치 0건 또는 허용 범위 내

---

### 4.3 Stage C: 100만원 실거래 점진 전환

#### C-1. 점진 배치
1) **Pilot 10%**: 100,000 KRW 한도, 24~48시간
2) **Pilot 50%**: 500,000 KRW 한도, 2~3일
3) **Full 100%**: 1,000,000 KRW

#### C-2. 자동 차단(킬스위치) 조건
- 일일 손실 -2% 도달
- 주문 오류 연속 N회
- 정산 불일치 지속
- 외부 API 이상(지연/에러율 급증)

#### C-3. Stage C 통과 기준
- 각 단계에서 손실한도/오류한도 미위반
- 알림/대시보드/정산 모두 정상
- 운영자 수동 점검 체크리스트 100% 완료

---

## 5. 상세 작업 항목 (Why / 장점 / 추가 작업)

| 항목 | 왜 해야 하는가 | 기대 효과 | 추가 작업 |
|---|---|---|---|
| Paper 자본 1/10 축소 | 목표 실거래 규모와 동일 조건 검증 | 과신/과대포지션 방지 | 리셋 절차 문서화 |
| Live executor 분리 | paper/live 혼선 방지 | 롤백/테스트 용이 | 공통 인터페이스 추상화 |
| 거래소 정산 잡 | DB-실거래 불일치 탐지 | 장부 정합성 확보 | 불일치 자동 경고 |
| 킬스위치 강화 | 손실 확대 전 자동 차단 | 실계좌 보호 | 수동 override 절차 |
| 단계적 자금 활성화 | 급격한 리스크 진입 방지 | 실패 비용 최소화 | 단계별 승급 조건 문서화 |

---

## 6. 구현/수정 대상 파일(예정)

### 6.1 코드
- `src/engine/executor.py` (추상화 또는 live executor 분리)
- `src/engine/live_executor.py` (신규)
- `src/bot/main.py` (모드 스위치, startup check)
- `src/common/` (upbit client/auth 모듈 신규)
- `src/engine/risk_manager.py` (100만원 모드 파라미터 오버라이드)

### 6.2 배포/환경
- `deploy/cloud/oci/.env.example`
- `deploy/cloud/oci/.env` (운영 반영 시)
- `deploy/cloud/oci/docker-compose.prod.yml` (필요 시 env 주입)

### 6.3 문서
- `docs/work-result/21_live_trading_transition_1m_krw_result.md`
- `docs/troubleshooting/21_live_trading_transition_incidents.md` (이슈 발생 시)
- `docs/daily-startup-guide.md` (운영 절차 업데이트)

---

## 7. 검증 기준 (How to verify)

### 7.1 Stage A (Paper 100만원)
- 계좌 초기값이 1,000,000 KRW로 반영되었는지 확인
- 최근 3~7일 오류/손실한도/알림 누락 점검

### 7.2 Stage B (Live dry-run)
- 주문 서명/응답 코드/예외 처리 테스트
- 동일 주문 재전송 시 중복주문 차단 확인
- 정산 리포트에서 불일치 건수 확인

### 7.3 Stage C (실거래)
- 단계별 자금 상한 준수 확인
- 킬스위치 트리거 테스트(샌드박스/모의 조건)
- Discord/Grafana에 실거래 지표 반영 확인

---

## 8. 롤백 전략
- 1차 롤백: `TRADING_MODE=paper` 즉시 전환 + bot 재기동
- 2차 롤백: 신규 live executor 비활성화, 기존 paper 경로로 복귀
- 3차 롤백: 키 폐기/재발급, 주문 권한 일시 중지

---

## 9. 일정 및 마일스톤(초안)
- D0~D2: Stage A (Paper 100만원) 안정화
- D3~D5: Stage B (Live executor + dry-run)
- D6~D10: Stage C (10% -> 50% -> 100% 단계 전환)

---

## 10. 오픈 이슈 / 의사결정 필요 항목
1. 100만원 기준 초기 리스크 파라미터 최종값(3%/2%/3회) 확정
2. 실거래 시 대상 심볼 축소 여부(BTC only로 시작할지)
3. Stage C 승급 최소 운영일수(24h vs 48h) 확정

---

## 11. 문서 반영
- work-plan/work-result 업데이트:
  - 본 계획 문서 생성 완료
  - 구현 후 `docs/work-result/21_live_trading_transition_1m_krw_result.md` 작성
- PROJECT_CHARTER.md 업데이트 필요 여부 및 반영 내역:
  - 현재는 실행 전 계획 단계이므로 즉시 변경 없음
  - 실거래 전환 정책 확정 시 Charter Changelog 반영 예정

---

## 12. 후속 조치
- 다음에 유사 문제 방지를 위한 작업:
  1) paper/live 모드 간 공통 테스트 하네스 구축
  2) 실거래 전환 체크리스트를 PR 템플릿/릴리스 체크에 강제
